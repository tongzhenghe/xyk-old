<?php/** * Created by PhpStorm. * User: Administrator * Date: 2019/4/23 * Time: 9:11 */namespace app\index\controller;use app\index\model\Imglib;use think\Db;class Ukie  extends Common{    public  function  test()    {        return view();    }    public  function  home()    {        $where = ['status' => 1, 'is_del' => 1];        //banner        $banner = Db::name('banner')            ->where($where)            ->field('pic')            ->select();        //新闻资讯        $re_news = Db::name('news')            ->where(['is_recommend' => 1])->where($where)            ->field('id, intro, create_time,icon')            ->limit(5)            ->select();        foreach ($re_news as &$v ) {            $v['intro'] = mb_substr($v['intro'], 0, 100);            $v['create_time'] = timeTran($v['create_time']);        }        //专家团队        $re_doctor = Db::name('team')            ->where($where)->where(['is_recommend' => 1])            ->order('sort asc')            ->field('id,icon')            ->select();        $team = [];        foreach ($re_doctor as  $key   => &$v   ) {            $team[] = array_slice($re_doctor, $key * 3 ,3);        }        $team = array_filter($team);        //服务项目        $activity = Db::name('activity')            ->where(['is_recommend' => 1])            ->field('id ')            ->where($where)->find();        //环境        $ambient = Db::name('ambient')            ->where(['is_recommend' => 1])            ->where($where)            ->field('id, icon')            ->select();        //问答        $re_ask = Db::name('asks')            ->where(['is_recommend' => 1])            ->where($where)            ->field('id, intro, title, create_time')            ->order('id DESC')            ->limit(5)            ->select();        foreach ($re_ask as &$v ) {            $v['intro'] = mb_substr(unserialize($v['intro']), 0,100).'...';            $v['create_time'] = timeTran($v['create_time']);        }        if (request()->isAjax()) {            $params = request()->param();            if (empty($params['user_name']))                exit(return_json('', 400, false, '请填写您的姓名！'));            $preg_phone='/^1[34578]\d{9}$/ims';            if(!preg_match($preg_phone,trim($params['tel'])))                exit(return_json('', 400, false, '手机为空或格式不正确！'));            $data = [                'time' => time()                ,'user_ip' => get_ip()                ,'user_name' => trim( $params['user_name'] )                ,'tel' => $params['tel']                ,'msg' => $params['msg']            ];            $result = Db::name('message')->insert($data);            if ($result) exit(return_json('', 200, true, '提交成功, 祝您生活愉快^_^！'));        }      return view('',  [          'banner' => $banner          ,'re_news' => $re_news          ,'team' => $team          ,'activity' => $activity          ,'ambient' => $ambient          ,'re_ask' => $re_ask          ]);    }    /**     * @return \think\response\View     * @throws \think\db\exception\DataNotFoundException     * @throws \think\db\exception\ModelNotFoundException     * @throws \think\exception\DbException     */    public function  about()    {        $about = Db::name('contact')->where('id', 1)->find();        $about['corporate_culture'] = html_entity_decode($about['corporate_culture']);        $about['content'] = html_entity_decode($about['content']);        return view('', ['data' => $about]);    }    //新闻    public  function  news()    {        $id =intval( input('id'));        if (!empty($id)) {            if (empty(request()->get('point'))) {                //下一篇标题                $next_data = Db::name('news')->where('id', $id + 1 )->field('title')->where('status',1)->find();                if (!empty($next_data)) {                    $this->assign('next_data', $next_data);                }                //上一篇标题                $upper_data = Db::name('news')->where('id', $id - 1 )->field('title')->where('status',1)->find();                if (!empty($upper_data)) {                    $this->assign('upper_data', $upper_data);                }            }            $where2 = $order =  $limit = '';            if (request()->get('do') == 'paging' ) {                if (request()->get('point') == 'up_paging' ) {                    //上一篇标题                    $upper_data = Db::name('news')->where('id', $id - 2 )->field('title')->where('status',1)->find();                    if (!empty($upper_data)) {                        $this->assign('upper_data', $upper_data);                    }                    //下一篇标题                    $next_data = Db::name('news')->where('id', $id  )->field('title')->where('status',1)->find();                    if (!empty($next_data)) {                        $this->assign('next_data', $next_data);                    }                    $min_id  =  Db::name('news')->min('id');                    if ($min_id < $id  ) {                        $where2 = 'id < '.$id;                    }                    $order = 'id desc';                    $limit = '0, 1';                    if (intval($min_id+1) === intval($id )) {                        $this->assign('up_disabled', true);                    }                }                if (request()->get('point') == 'down_paging' ) {                    //下一篇标题                    $next_data = Db::name('news')->where('id', $id   + 2   )->field('title')->where('status',1)->find();                    if (!empty($next_data)) {                        $this->assign('next_data', $next_data);                    }                    //上一篇标题                    $upper_data = Db::name('news')->where('id', $id  )->field('title')->where('status',1)->find();                    if (!empty($upper_data)) {                        $this->assign('upper_data', $upper_data);                    }                    $max_id  =  Db::name('news')->max('id');                    if (intval($max_id-1 ) === intval($id )) {                        $this->assign('down_disabled', true);                    }                    if($max_id  > $id ) {                        $where2 = 'id > '.$id;                    }                    $order = 'id asc';                    $limit = '0, 1';                }            }            //详情            $point =  request()->get('point');            $newsinfo = Db::name('news')->where($where2)->order($order)->limit($limit)->where(empty($point ) ?  ['id'  => $id ] : null  )->find();            if (!empty($newsinfo)) {                $newsinfo['content'] = html_entity_decode($newsinfo['content']);                $newsinfo['create_time'] = date('Y/m/d H:i:s', $newsinfo['create_time']);                wl_debug($newsinfo);                $this->assign('data', $newsinfo);            }            //热门阅读            $hot_asks = Db::name('asks')->where(['is_hot' => 1, 'status' => 1, 'is_del' => 1])->select();            if (!empty($hot_asks)) {                $this->assign('hot_asks', $hot_asks);            }            return view('index/newsinfo');        }        //列表分页        if (request()->post('do') == 'next_news' ) {            $input_post = input("post.");            if (isset($input_post) && !empty($input_post)) {                $offect = intval( $input_post['offect']);                $show_list = Db::name("news")->limit( $offect, 1)->select();                foreach ($show_list as &$item  ) {                    $item['intro'] =  mb_substr($item['intro'], 0, 35, 'utf-8') . '.....';                }                if(isset( $show_list ) && !empty( $show_list )) {                    exit(json_encode($show_list));                } else {                    return false ;                }            }        } else {            $page_size  =  6;            $news = Db::name('news')->where(['status' => 1, 'is_del' => 1])->order('id asc')->paginate($page_size ,  false );            $page = request()->get('page') ? request()->get('page') : 1;            if (!empty($news)) {                $this->assign('news', $news);                $this->assign('page', $page);            }        }        return view();    }    /*     * 新闻列表     */    public  function  news_list()    {        $params = request()->param();        $where = ['status' => 1, 'is_del' => 1 ];        $news_list = Db::name('news')            ->where($where)            ->paginate(5,true)->each(function($item, $key) {                $item['create_time'] = timeTran( $item['create_time'] );                $item['intro'] = utf8_sub_str( $item['intro'], 0, 45 ).'..';                return $item;            });        //info        if (!empty($params['id'])) {            //推荐            $hot_news = Db::name('news')                ->where('is_recommend', 1)                ->field('create_time, id, intro, icon')                ->limit(5)                ->where($where)                ->select();            foreach ($hot_news as &$item  ) {                $item['intro'] =  mb_substr($item['intro'], 0, 35, 'utf-8') . '.....';                $item['create_time'] =  timeTran($item['create_time']);            }            //篇章分页            $where2 = $order =  $limit = '';            $max_id  =  Db::name('news')->max('id');            $min_id  =  Db::name('news')->min('id');            //上一页            if (!empty($params['do'])) {                if ($params['do'] == 'up_paging' ) {                    if ($min_id < $params['id']  ) {                        $where2 = 'id < '. $params['id'];                    }                    $order = 'id desc';                    $limit = '0, 1';                    if ($min_id  == $params['id']-1)                        $this->assign('up_disabled', true);                }                if ($params['do']  == 'down_paging' ) {                    //当用户点击下一页， 最大也id 6， 当当前这个id大于或者等于最大这个id                    if ($max_id <= $params['id']+1) {                        $this->assign('down_disabled', true);                    }                    if($max_id  > $params['id']  ) {                        $where2 = 'id > '.$params['id'] ;                    }                    $order = 'id asc';                    $limit = '0, 1';                }            }            if ($min_id == $params['id'])  $this->assign('up_disabled', true);            if ($max_id == $params['id'])  $this->assign('down_disabled', true);            $new_info = Db::name('news')                ->where(empty($params['do'] ) ?  ['id'  => intval($params['id']) ] : null  )                ->where($where2)                ->order($order)                ->limit($limit)                ->find();            $new_info['content'] = html_entity_decode( $new_info['content'] );            $new_info['create_time'] = timeTran( $new_info['create_time'] );                return view('news_info', ['data' => $new_info, 'hot_news'=> $hot_news]);        }        return view('', ['Obj' => $news_list, 'news_list' => $news_list->items()]);    }    /*     * 问答列表     */    public  function  ask_list()    {        $params = request()->param();        $where = ['status' => 1, 'is_del' => 1 ];        $ask_list = Db::name('asks')            ->where($where)            ->field('id, intro,create_time, title,  icon')            ->paginate(5,true)->each(function($item, $key) {                $item['create_time'] = timeTran( $item['create_time'] );                $item['intro'] =  unserialize($item['intro']);                $item['intro'] = utf8_sub_str( $item['intro'], 0, 35 ).'..';                $item['title'] = utf8_sub_str( $item['title'], 0, 20 ).'..';                return $item;            });        //info        if (!empty($params['id'])) {            //推荐            $hot_ask = Db::name('asks')                ->where('is_recommend', 1)                ->field('create_time, id, intro, title,icon')                ->limit(5)                ->where($where)                ->select();            foreach ($hot_ask as &$item  ) {                $item['intro'] =  unserialize($item['intro']);                $item['intro'] = utf8_sub_str( $item['intro'], 0, 45 ).'..';                $item['create_time'] =  timeTran($item['create_time']);            }            //篇章分页            $where2 = $order =  $limit = '';            $max_id  =  Db::name('asks')->max('id');            $min_id  =  Db::name('asks')->min('id');            //上一页            if (!empty($params['do'])) {                if ($params['do'] == 'up_paging' ) {                    if ($min_id < $params['id']  ) {                        $where2 = 'id < '. $params['id'];                    }                    $order = 'id desc';                    $limit = '0, 1';                    if ($min_id  == $params['id']-1)                        $this->assign('up_disabled', true);                }                if ($params['do']  == 'down_paging' ) {                    //当用户点击下一页， 最大也id 6， 当当前这个id大于或者等于最大这个id                    if ($max_id <= $params['id']+1) {                        $this->assign('down_disabled', true);                    }                    if($max_id  > $params['id']  ) {                        $where2 = 'id > '.$params['id'] ;                    }                    $order = 'id asc';                    $limit = '0, 1';                }            }            if ($min_id == $params['id'])  $this->assign('up_disabled', true);            if ($max_id == $params['id'])  $this->assign('down_disabled', true);            $ask_info = Db::name('asks')                ->where(empty($params['do'] ) ?  ['id'  => intval($params['id']) ] : null  )                ->where($where2)                ->order($order)                ->limit($limit)                ->find();            $ask_info['content'] = html_entity_decode( $ask_info['content'] );            $ask_info['create_time'] = timeTran( $ask_info['create_time'] );            $ask_info['intro'] = unserialize( $ask_info['intro'] );            return view('ask_info', ['ask_info' => $ask_info, 'hot_ask'=> $hot_ask]);        }        return view('', ['Obj' => $ask_list, 'ask_list' => $ask_list->items()]);    }    /**     * @return \think\response\View     * @throws \think\db\exception\DataNotFoundException     * @throws \think\db\exception\ModelNotFoundException     * @throws \think\exception\DbException     */    public  function ambient()    {        $where = ['status' => 1, 'is_del' => 1];        //根据分类获取分类及下面的环境        $ambient = Db::name('ambient_category')->where($where)->select();        foreach ($ambient as &$v ) {            $v['ambient_icon'] = Db::name('ambient')                ->where($where)                ->field('icon, title')                ->where('cateid', $v['id'])                ->select();        }        return view('', ['ambient' => $ambient]);    }    /**     *     *  医师详情     *     */    public  function  doci()    {        $params = request()->param();        if (!empty($params['id'])) {            $id = intval($params['id']);            $doci = Db::name('team')->where('id', $id)->field('intro,description')->find();            if (!empty($doci['description'])) $doci['description'] = unserialize($doci['description']);            return view('', ['data' => $doci]);        }    }    /**     * 收费标准     * @return \think\response\View     */    public  function fees()    {        return view();    }}